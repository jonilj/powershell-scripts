#!/bin/bash
#Automatically uninstalls and reinstalls GlobalProtect
#Based on a script created 2020-6-2 by Shaquir Tannis, modified by Joni Ljungqvist 2021-11-26.
#Influenced by https://www.jamf.com/jamf-nation/discussions/35211/updates-to-google-chrome-deployment-for-macos#responseChild200000

#Uninstall GlobalProtect if it is installed
filetocheck=/Applications/GlobalProtect.app
if test -f "$filetocheck"; then
    source /Applications/GlobalProtect.app/Contents/Resources/uninstall_gp.sh
    echo "$filetocheck found, proceeding to uninstall before reinstallation."
else
    echo "$filetocheck not found, proceeding to installation."
fi

#Download and install GlobalProtect
programDownloadUrl=$(curl 'https://installpath' -s -L -I -o /dev/null -w '%{url_effective}')
pkgName="GlobalProtect.pkg"
programPkgPath="/tmp/$pkgName"
logfile="/Library/Logs/ScriptInstaller.log"
/bin/echo "--" >> ${logfile}
/bin/echo "`date`: Downloading program." >> ${logfile}

#Downloads file
/usr/bin/curl -L -o "$programPkgPath" "$programDownloadUrl"
/bin/echo "`date`: Installing $pkgName..." >> ${logfile}

#Install PKG
cd /tmp
/usr/sbin/installer -pkg "$pkgName" -target /
/bin/sleep 10
/bin/echo "`date`: Deleting package installer." >> ${logfile}

#Modify PLIST to reflect the correct portal address.
echo '<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>Palo Alto Networks</key><dict><key>GlobalProtect</key><dict><key>PanSetup</key><dict><key>Portal</key><string>'portalAddress'</string><key>Prelogon</key><integer>0</integer></dict></dict></dict></dict></plist>' >> /Library/Preferences/com.paloaltonetworks.GlobalProtect.settings.plist

#Remove package if it still exists
if test -f "$programPkgPath"; then
    /bin/rm "$programPkgPath"
else
    echo "$programPkgPath does not exist."
fi